<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin</title>
  <style>
    body { font-family: Arial; margin:0; display:flex; height:100vh; }
    .left { width:280px; border-right:1px solid #ddd; padding:12px; overflow:auto; }
    .mid { flex:1; padding:12px; overflow:auto; }
    button { padding:8px 10px; margin:4px 0; width:100%; }
    .sec { border:1px solid #ddd; border-radius:10px; padding:10px; margin-bottom:8px; }
  </style>
</head>
<body>
  <div class="left">
    <h3>Bloques</h3>
    <div id="blocks"></div>
    <hr>
    <button id="save">Guardar (draft)</button>
    <button id="publish">Publicar</button>
    <p style="font-size:12px;color:#666">Después de publicar, ve a <b>/</b></p>
  </div>

  <div class="mid">
    <h3>Secciones</h3>
    <div id="sections"></div>
  </div>

  <script>
    let registry = [];
    let draft = null;

    const elBlocks = document.getElementById("blocks");
    const elSections = document.getElementById("sections");

    function uid(){ return "s" + Math.random().toString(16).slice(2); }

    async function load() {
      registry = await fetch("/api/admin/blocks").then(r => r.json());
      draft = await fetch("/api/admin/site").then(r => r.json());
      renderBlocks();
      renderSections();
    }

    function renderBlocks() {
      elBlocks.innerHTML = "";
      registry.forEach(b => {
        const btn = document.createElement("button");
        btn.textContent = "➕ " + b.name;
        btn.onclick = () => {
          draft.sections.push({ id: uid(), type: b.type, props: structuredClone(b.defaultProps) });
          renderSections();
        };
        elBlocks.appendChild(btn);
      });
    }

    function renderSections() {
      elSections.innerHTML = "";
      draft.sections.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "sec";
        div.innerHTML = `
          <b>${i+1}. ${s.type}</b>
          <pre style="white-space:pre-wrap">${JSON.stringify(s.props, null, 2)}</pre>
          <button data-del>Eliminar</button>
        `;
        div.querySelector("[data-del]").onclick = () => {
          draft.sections = draft.sections.filter(x => x.id !== s.id);
          renderSections();
        };
        elSections.appendChild(div);
      });
    }

    document.getElementById("save").onclick = async () => {
      await fetch("/api/admin/site/save", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(draft)
      });
      alert("Guardado ✅");
    };

    document.getElementById("publish").onclick = async () => {
      await fetch("/api/admin/site/publish", { method: "POST" });
      alert("Publicado ✅ (abre /)");
    };

    load().catch(console.error);
  </script>
</body>
</html>
